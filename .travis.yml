sudo: false

language: python

cache: pip

dist: xenial

addons:
  apt:
    packages:
    - gnutls-bin
    - libgnutls-dev

matrix:
  include:
    - python: 2.7
      env: TOXENV=py27
    - python: 3.6
      env: TOXENV=py36
    - python: 2.7
      env: TOXENV=pep8py2
    - python: 3.6
      env: TOXENV=pep8py3
    - python: 3.6
      env: TOXENV=py36 PYTHONEXE=python3 PATH=/tmp/softhsm/bin:$PATH LD_LIBRARY_PATH=/tmp/softhsm/bin
      addons:
        apt:
          packages:
          - gnutls-bin
          - libgnutls-dev
          - libssl-dev
      before_script:
        - if [ -z "$(type -P softhsm2-util)" ]; then
            wget https://dist.opendnssec.org/source/softhsm-2.5.0.tar.gz
            && tar -xzf softhsm-2.5.0.tar.gz
            && cd softhsm-2.5.0
            && mkdir -p /tmp/softhsm/bin
            && ./configure --prefix=/tmp/softhsm --libdir=/tmp/softhsm/bin
            && make -j$(nproc)
            && sudo make install
            && cd ..;
          fi;
      script:
        - tox
          && $PYTHONEXE setup.py test

install:
  - pip install --upgrade pip setuptools
  - pip --version
  - pip install tox
  - tox --version

script:
  - tox

after_failure:
  - cat .tox/py27/log/py27-*.log
